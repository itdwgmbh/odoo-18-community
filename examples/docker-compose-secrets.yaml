# Docker Compose with secrets support
# Recommended for production deployments and Docker Swarm
#
# Usage:
#   1. Create secrets directory and files (without trailing newline):
#      mkdir -p secrets && chmod 700 secrets
#      echo -n "your_db_password" > secrets/db_password.txt
#      echo -n "your_master_password" > secrets/odoo_master_password.txt
#      chmod 600 secrets/*.txt
#
#   2. Deploy:
#      docker compose -f docker-compose-secrets.yaml up -d
#
#   For Docker Swarm:
#      docker secret create db_password secrets/db_password.txt
#      docker secret create odoo_master_password secrets/odoo_master_password.txt
#      docker stack deploy -c docker-compose-secrets.yaml odoo

services:
  nginx:
    image: nginx:alpine
    depends_on:
      - web
    ports:
      - "8069:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped

  web:
    build: ../docker
    # Or use pre-built image:
    # image: ghcr.io/itdwgmbh/odoo-18-community:latest
    depends_on:
      - db
    environment:
      - DB_HOST=db
      - DB_USER=${DB_USER:-odoo}
      # Use _FILE variants to read passwords from mounted secrets
      - DB_PASSWORD_FILE=/run/secrets/db_password
      - ODOO_MASTER_PASSWORD_FILE=/run/secrets/odoo_master_password
      # SMTP password (optional, uncomment if needed)
      # - ODOO_SMTP_PASSWORD_FILE=/run/secrets/smtp_password
      # Important: Enable proxy mode when behind nginx
      - ODOO_PROXY_MODE=True
    secrets:
      - db_password
      - odoo_master_password
      # - smtp_password
    volumes:
      - odoo-data:/var/lib/odoo
      - odoo-config:/etc/odoo
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped

  db:
    image: postgres:17
    environment:
      - POSTGRES_DB=postgres
      - POSTGRES_USER=${DB_USER:-odoo}
      # PostgreSQL also supports POSTGRES_PASSWORD_FILE
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
    secrets:
      - db_password
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
    command: ["postgres", "-c", "log_statement=all", "-c", "log_destination=stderr"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready", "-d", "postgres"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  mail:
    image: maildev/maildev
    # SMTP port 1025, Web UI on port 1080 (accessed via nginx at mail.localhost)
    # Configure Odoo SMTP: Host=mail, Port=1025, No SSL/TLS
    restart: unless-stopped

# Define secrets - for local development, use file-based secrets
# For Docker Swarm, use: docker secret create <name> <file>
secrets:
  db_password:
    file: ./secrets/db_password.txt
  odoo_master_password:
    file: ./secrets/odoo_master_password.txt
  # Uncomment if SMTP authentication is needed
  # smtp_password:
  #   file: ./secrets/smtp_password.txt

volumes:
  odoo-data:
  odoo-config:
  postgres-data:
