# Full-featured docker-compose with Nginx reverse proxy, WebSocket support, and mail server
# Copy this file and .env.example to your project directory to get started

services:
  nginx:
    image: nginx:alpine
    depends_on:
      - web
    ports:
      - "8069:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped

  web:
    build: ../docker
    # Or use pre-built image:
    # image: ghcr.io/itdwgmbh/odoo-18-community:latest
    depends_on:
      - db
    environment:
      - DB_HOST=db
      - DB_USER=${DB_USER:-odoo}
      - DB_PASSWORD=${DB_PASSWORD:-odoo}
      - ODOO_MASTER_PASSWORD=${ODOO_MASTER_PASSWORD:-changeme}
      # Important: Enable proxy mode when behind nginx
      - ODOO_PROXY_MODE=True
    volumes:
      - odoo-data:/var/lib/odoo
      - odoo-config:/etc/odoo
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped

  db:
    image: postgres:17
    environment:
      - POSTGRES_DB=postgres
      - POSTGRES_PASSWORD=${DB_PASSWORD:-odoo}
      - POSTGRES_USER=${DB_USER:-odoo}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
    command: ["postgres", "-c", "log_statement=all", "-c", "log_destination=stderr"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready", "-d", "postgres"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped
    
  mail:
    image: maildev/maildev
    # SMTP port 1025, Web UI on port 1080 (accessed via nginx at mail.localhost)
    # Configure Odoo SMTP: Host=mail, Port=1025, No SSL/TLS
    restart: unless-stopped

volumes:
  odoo-data:
  odoo-config:
  postgres-data: