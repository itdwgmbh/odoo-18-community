# Upstream definitions
upstream odoo {
    server web:8069;
}

upstream odoo-chat {
    server web:8072;
}

upstream maildev {
    server mail:1080;
}

# WebSocket upgrade mapping
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# Redirect all traffic from port 80 to the appropriate subdomain
server {
    listen 80 default_server;
    server_name _;
    
    # Redirect to odoo.localhost by default
    return 301 http://odoo.localhost$request_uri;
}

# Odoo application - odoo.localhost
server {
    listen 80;
    server_name odoo.localhost;

    # Add Headers for odoo proxy mode
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP $remote_addr;
    
    # Increase proxy buffer sizes
    proxy_buffers 16 64k;
    proxy_buffer_size 128k;
    
    # Enable keepalive
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    
    # By default, do not forward anything
    proxy_redirect off;
    proxy_buffering off;

    # Redirect websocket requests to gevent port
    location /websocket {
        proxy_pass http://odoo-chat;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
        
        # WebSocket specific
        proxy_read_timeout 86400;
    }

    # Redirect longpoll requests to gevent port
    location /longpolling {
        proxy_pass http://odoo-chat;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Handle all other requests
    location / {
        proxy_pass http://odoo;
        
        # Force timeouts if backend dies
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        send_timeout 600s;
        
        # By default, do not forward anything
        proxy_redirect off;
    }

    # Cache static data
    location ~* /web/static/ {
        proxy_pass http://odoo;
        proxy_cache_valid 200 90m;
        proxy_buffering on;
        expires 864000;
    }

    # Gzip compression
    gzip on;
    gzip_types text/css text/scss text/plain text/xml application/xml application/json application/javascript;
    gzip_min_length 256;
}

# MailDev web interface - mail.localhost
server {
    listen 80;
    server_name mail.localhost;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Proxy configuration
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Enable WebSocket support for MailDev
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    
    # Timeouts
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    location / {
        proxy_pass http://maildev;
        proxy_redirect off;
        
        # MailDev specific: Handle EventSource for real-time updates
        proxy_set_header Cache-Control 'no-cache';
        proxy_set_header X-Accel-Buffering 'no';
        proxy_buffering off;
    }

    # Gzip compression
    gzip on;
    gzip_types text/css text/scss text/plain text/xml application/xml application/json application/javascript;
    gzip_min_length 256;
}